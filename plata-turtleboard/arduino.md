# Работа с Arduino

На плате размещен микроконтроллер ATMega 2560 с обвязкой, индентичной таковой на плате Arduino Mega. Контроллер поставляется с прошитым бутлоадером Arduino. Таким образом, микроконтроллер полностью готов к запуску скетчей Arduino IDE и работе со стандартными шилдами для Ардуино.

Для работы с МК необходимо [скачать](https://www.arduino.cc/en/Main/Software) и запустить Arduino IDE с сайта[ arduino.cc](https://www.arduino.cc/en/Main/Software). В настройках IDE выбрать плату Arduino Mega 2560.

## Библиотека Arduino ros\_lib

Для работы с Arduino через ROS необходимо установить библиотеку ros\_lib `<ros.h>`.

Скачать библиотеку можно здесь: [https://yadi.sk/d/BcI1126boKkf-A](https://yadi.sk/d/BcI1126boKkf-A)

Инструкция по установке библиотек для Arduino IDE [https://www.arduino.cc/en/guide/libraries](https://www.arduino.cc/en/guide/libraries#)

Но если вы используете кастомные сообщения или у вас появляются ошибки при сборке скетчей, вам необходимо "пересобрать" библиотеку `ros_lib` самостоятельно с помощью команды \(выполнив ее на роботе\)

```text
rosrun rosserial_arduino make_libraries.py .
```

Вызванная утилита `rosserial_arduino` соберет новую библиотеку на основе настроек ROS вашего робота и положит ее в корневую директорию пользователя `/home/pi/`. Дальше вам надо переписать ros\_lib с робота на ваш компьютер и поместить его в директорию библиотек Arduino в соответствии с инструкцией по установке библиотек для Arduino IDE.

## Взаимодействие с ROS

Arduino Mega подключена к Raspberry через порт Serial1. Со стороны ROS запущен сервис `rosserial` который организует взаимодействие МК и ROS.

Для подключения к ROS со стороны Arduino необходимо инициализировать библиотеку ros\_lib `<ros.h>` отвечающую за коммуникацию между Arduino и ROS, указав параметры Serial1 и скорость 115200, как показано ниже.

```c
#include <ros.h>

class NewHardware : public ArduinoHardware
{
  public:
  NewHardware():ArduinoHardware(&Serial1, 115200){};
};

ros::NodeHandle_<NewHardware>  nh;
```

Примеры можно посмотреть в официальной документации rosserial [http://wiki.ros.org/rosserial\_arduino/Tutorials](http://wiki.ros.org/rosserial_arduino/Tutorials)

## Дополнительные возможности Arduino

В передней части системной платы робота расположены две кнопки, подключенные к ножкам `D24` и `D23` МК Arduino и два переключателя, подключенные соответственно к `D22` и `D25`. При нажатии кнопки или переключателя на пине Arduino будет сингал `HIGH` Для чтения значения необходимо использовать Arduino функцию `digitalRead(pin)`

С левой стороны системной платы находятся пины `D44 D45 D46`, которые можно использовать для подключения сервомашинок. 

{% hint style="danger" %}
**ВНИМАНИЕ: на сервомашинки подается напряжение 5В от отдельного источника питания! Ни в коем случае нельзя соединять пины питания сервомашинок с пинами питания, выведенными на колодку Ардуино.**
{% endhint %}

Перед лидаром расположены 4 светодиода, подключенные к пинам `D26, D27, D28, D29.`

## Работа со светодиодной лентой

Под платой расположено 24 RGB светодиода модели WS2812. Для работы со светодиодной лентой используйте библиотеку FastLED [https://github.com/FastLED/FastLED](https://github.com/FastLED/FastLED) Управляющий пин для ленты `D30`.

### **Удаленная загрузка скетча Arduino**

Если есть необходимость удаленно \(без доступа к роботу\) обновить прошивку Arduino, то это возможно сделать имея только удаленный доступ.

**Подготовить скетч к загрузке**

1. В Arduino IDE выбрать МК Arduino/Genuino Mega or Mega 2560
2. Скомпилировать программу \(кнопка Проверить\)
3. В меню выбрать Скетч→Экспорт Бинарного файла
4. В директории где находиться файл скетча, будут созданы два файла с бинарными данными вида \(sketch\_mar24a.ino.mega.hex sketch\_mar24a.ino.with\_bootloader.mega.hex\)
5. Мы должны использовать файл `sketch_mar24a.ino.mega.hex`

**Загрузить бинарный файл на Arduino:**

1. Скопировать файлы `.hex` на робота, например командой linux scp
2. На роботе выполнить команду "прошивки" платы Arduino 

```c
avrdude -v -v -p atmega2560 -c wiring -P /dev/serial/by-id/usb-Silicon_Labs_CP2102_USB_to_UART_Bridge_Controller_0001-if00-port0 -b 115200 -D -U flash:w:sketch_mar24a.ino.mega.hex:i
```

Где `sketch_mar24a.ino.mega.hex` имя файла с прошивкой.  
  
Для возможности удаленной прошивки платы, необходимо чтобы Arduino разъем на плате Turtlebro был подключен к RaspberryPi через Micro-USB.

